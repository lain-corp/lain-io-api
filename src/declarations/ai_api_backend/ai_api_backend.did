type chat_message = variant {
  tool : record { content : text; tool_call_id : text };
  user : record { content : text };
  assistant : record {
    content : opt text;
    tool_calls : vec record {
      id : text;
      function : record {
        name : text;
        arguments : vec record {
          name : text;
          value : text;
        };
      }
    };
  };
  system : record { content : text };
};

type room_config = record {
  id : text;
  name : text;
  description : text;
};

type personality_embedding = record {
  text: text;
  embedding: vec float32;
  channel_id: text;
  category: text;
  importance: float32;
  created_at: nat64;
};

type conversation_embedding = record {
  user_id: text;
  channel_id: text;
  conversation_text: text;
  embedding: vec float32;
  message_count: nat32;
  chunk_index: nat32;
  created_at: nat64;
  summary: text;
};

type big_five_traits = record {
  openness: float32;
  conscientiousness: float32;
  extraversion: float32;
  agreeableness: float32;
  neuroticism: float32;
};

type topic_interest = record {
  topic: text;
  engagement_score: float32;
  message_count: nat32;
  expertise_level: float32;
  first_mentioned: nat64;
  last_mentioned: nat64;
};

type user_profile = record {
  user_id: text;
  personality_traits: big_five_traits;
  interests: vec topic_interest;
  aggregated_embedding: vec float32;
  conversation_count: nat32;
  total_messages: nat32;
  created_at: nat64;
  updated_at: nat64;
};

// Search result type for unified knowledge search
type search_result = record {
  text: text;
  similarity: float32;
  category: text;
  importance: float32;
  source_info: text;
  content_type: text;
};

// Category info for knowledge base
type category_info = record {
  category: text;
  count: nat32;
  description: text;
};

// Knowledge base statistics
type knowledge_stats = record {
  total_embeddings: nat32;
  personality_embeddings: nat32;
  wiki_embeddings: nat32;
  categories: vec category_info;
};

service: {
  chat: (vec chat_message, opt text) -> (text);
  chat_default: (vec chat_message) -> (text);
  chat_with_rag: (vec chat_message, opt text, vec float32) -> (text);
  chat_with_user_context: (vec chat_message, text, opt text, vec float32) -> (text);
  chat_with_knowledge: (vec chat_message, opt text, vec float32, opt vec text) -> (text);
  get_available_rooms: () -> (vec room_config) query;
  store_personality: (personality_embedding) -> (text);
  store_personality_batch: (vec personality_embedding) -> (text);
  get_personality_embeddings: () -> (vec personality_embedding) query;
  search_personality: (text, vec float32) -> (vec text) query;
  
  // Unified Knowledge Search API (searches across all personality + wiki embeddings)
  search_unified_knowledge: (vec float32, opt vec text, opt nat32) -> (vec search_result) query;
  search_wiki_content: (vec float32, opt text, opt nat32) -> (vec search_result) query;
  get_knowledge_categories: () -> (vec category_info) query;
  get_knowledge_stats: () -> (knowledge_stats) query;
  
  // Text-based search (NO EMBEDDING REQUIRED - uses keyword matching)
  search_knowledge_by_text: (text, opt vec text, opt nat32) -> (vec search_result) query;
  
  store_conversation_chunk: (conversation_embedding) -> (text);
  get_user_conversations: (text, text) -> (vec conversation_embedding) query;
  get_next_conversation_chunk_index: (text, text) -> (nat32) query;
  search_user_conversation_history: (text, text, vec float32, opt nat32) -> (vec text) query;
  get_recent_user_conversations: (text, text, opt nat32) -> (vec text) query;
  get_user_conversation_stats: (text, text) -> (nat32, nat32) query;
  
  // User Profiling API
  get_user_profile_by_id: (text) -> (opt user_profile) query;
  create_user_profile: (text) -> (opt user_profile);
  get_all_user_profiles: () -> (vec user_profile) query;
  analyze_user_personality: (text) -> (opt big_five_traits) query;
  analyze_user_interests: (text) -> (vec topic_interest) query;
  calculate_user_similarity: (text, text) -> (opt float32) query;
  get_friendship_recommendations: (text, opt nat32) -> (vec record { text; float32 }) query;
}